name: Veyon -> WinGet PR Automation

on:
  workflow_dispatch:
  schedule:
    - cron: "17 */6 * * *" # alle 6 Stunden (UTC)

permissions:
  contents: read

concurrency:
  group: veyon-winget
  cancel-in-progress: true

jobs:
  veyon-winget:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine latest Veyon release & decide if update needed
        id: meta
        shell: pwsh
        run: |
          $headers = @{ "User-Agent" = "veyon-winget-bot"; "Accept" = "application/vnd.github+json" }

          # 1) Neueste Veyon Release holen
          $rel = Invoke-RestMethod -Uri "https://api.github.com/repos/veyon/veyon/releases/latest" -Headers $headers
          $tag = $rel.tag_name  # z.B. v4.10.1

          # Version möglichst exakt aus dem Asset-Namen ziehen (z.B. veyon-4.10.1.0-win64-setup.exe)
          $assetX64 = $rel.assets | Where-Object { $_.name -match 'win64-setup\.exe$' } | Select-Object -First 1
          $version = $null
          if ($assetX64 -and $assetX64.name -match 'veyon-(\d+\.\d+\.\d+\.\d+)-win64-setup\.exe$') {
            $version = $Matches[1]
          } else {
            # Fallback: tag vX.Y.Z -> X.Y.Z.0
            $ver3 = $tag.TrimStart('v')
            $version = "$ver3.0"
          }

          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "notesUrl=$($rel.html_url)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "releaseDate=$(([DateTimeOffset]$rel.published_at).UtcDateTime.ToString('yyyy-MM-dd'))" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

          # 2) Schutz: existiert bereits ein offener PR für diese Version? -> dann NICHT nochmal erstellen
          $q = [uri]::EscapeDataString("repo:microsoft/winget-pkgs is:pr is:open VeyonSolutions.Veyon $version")
          $searchUri = "https://api.github.com/search/issues?q=$q"
          $search = Invoke-RestMethod -Uri $searchUri -Headers $headers

          if ($search.total_count -gt 0) {
            $existing = $search.items[0].html_url
            "needsUpdate=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "existingPr=$existing" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "Open PR already exists for this version: $existing"
            exit 0
          }

          # 3) ROBUSTER Check: Raw-Datei im winget-pkgs Repo (200 = vorhanden, 404 = nicht vorhanden)
          # Hinweis: Im Repo liegt es unter manifests/v/... (lowercase v) – und diese Datei existiert für 4.10.1.0 nachweislich. 
          $rawMaster = "https://raw.githubusercontent.com/microsoft/winget-pkgs/master/manifests/v/VeyonSolutions/Veyon/$version/VeyonSolutions.Veyon.installer.yaml"
          $rawMain   = "https://raw.githubusercontent.com/microsoft/winget-pkgs/main/manifests/v/VeyonSolutions/Veyon/$version/VeyonSolutions.Veyon.installer.yaml"

          function Test-RawUrl([string]$url) {
            $r = Invoke-WebRequest -Uri $url -Method Head -SkipHttpErrorCheck
            return $r.StatusCode
          }

          $code = Test-RawUrl $rawMaster
          if ($code -eq 200) {
            "needsUpdate=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "Already present in winget-pkgs (master): $version"
            exit 0
          }

          if ($code -eq 404) {
            # Fallback: falls branch mal "main" ist
            $code2 = Test-RawUrl $rawMain
            if ($code2 -eq 200) {
              "needsUpdate=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              Write-Host "Already present in winget-pkgs (main): $version"
              exit 0
            }
            if ($code2 -eq 404) {
              "needsUpdate=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              Write-Host "Not present in winget-pkgs yet: $version"
              exit 0
            }

            throw "Unexpected HTTP status $code2 for $rawMain – aborting to avoid PR spam."
          }

          throw "Unexpected HTTP status $code for $rawMaster – aborting to avoid PR spam."

      - name: Send START email (new version found)
        if: steps.meta.outputs.needsUpdate == 'true'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "Veyon Update gefunden: ${{ steps.meta.outputs.version }} – PR wird erstellt"
          from: ${{ secrets.MAIL_FROM }}
          to: ${{ secrets.MAIL_TO }}
          body: |
            Neue Veyon-Version gefunden: ${{ steps.meta.outputs.tag }} (winget: ${{ steps.meta.outputs.version }})
            Release Notes: ${{ steps.meta.outputs.notesUrl }}
            Prozess startet jetzt.

      - name: Install WingetCreate
        if: steps.meta.outputs.needsUpdate == 'true'
        shell: pwsh
        run: |
          winget install -e --id Microsoft.WingetCreate --accept-package-agreements --accept-source-agreements

      - name: Run Submit-VeyonWingetUpdate.ps1 (submit PR)
        if: steps.meta.outputs.needsUpdate == 'true'
        id: submit
        shell: pwsh
        env:
          WINGET_CREATE_GITHUB_TOKEN: ${{ secrets.WINGET_CREATE_GITHUB_TOKEN }}
        run: |
          $log = Join-Path $env:RUNNER_TEMP "wingetcreate.log"
          pwsh -File .\Submit-VeyonWingetUpdate.ps1 -Version "${{ steps.meta.outputs.version }}" *>&1 | Tee-Object -FilePath $log

          $pr = Select-String -Path $log -Pattern "https://github\.com/microsoft/winget-pkgs/pull/\d+" -AllMatches |
                ForEach-Object { $_.Matches.Value } | Select-Object -First 1

          if ($pr) {
            "prUrl=$pr" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Send END email (success/fail)
        if: always() && steps.meta.outputs.needsUpdate == 'true'
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "Veyon winget Prozess fertig – Status: ${{ job.status }}"
          from: ${{ secrets.MAIL_FROM }}
          to: ${{ secrets.MAIL_TO }}
          body: |
            Status: ${{ job.status }}
            Version: ${{ steps.meta.outputs.version }}
            PR: ${{ steps.submit.outputs.prUrl }}
            Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
